# SPDX-FileCopyrightText: Copyright 2024 LG Electronics Inc.
#
# SPDX-License-Identifier: Apache-2.0

# DO NOT USE this file if you can see this comment.

apiVersion: v1
kind: Pod
metadata:
  name: piccolo-server
spec:
  hostNetwork: true
  hostPid: true
  containers:
  - name: rocksdbservice
    image: ghcr.io/mco-piccolo/pullpiri-rocksdb:0.1
    command: ["rocksdbservice", "--path", "/data", "--addr", "$(HOST_IP)", "--port", "50051"]
    volumeMounts:
    - name: rocksdb-data
      mountPath: /data
    environment:
    - name: RUST_LOG
      value: "info"
    securityContext:
      runAsUser: 0
      runAsGroup: 0
  - name: apiserver
    image: localhost/pullpiri:latest
    command: ["/piccolo/apiserver"]
    volumeMounts:
    - name: piccolo-yaml
      mountPath: /etc/piccolo/yaml
    - name: config-path
      mountPath: /etc/piccolo/settings.yaml
    environment:
    - name: ROCKSDB_SERVICE_URL
      value: "http://$(HOST_IP):50051"
  - name: policymanager
    image: localhost/pullpiri:latest
    command: ["/piccolo/policymanager"]
    environment:
    - name: ROCKSDB_SERVICE_URL
      value: "http://$(HOST_IP):50051"
  - name: monitoringserver
    image: localhost/pullpiri:latest
    command: ["/piccolo/monitoringserver"]
    environment:
    - name: ROCKSDB_SERVICE_URL
      value: "http://$(HOST_IP):50051"
    volumeMounts:
    - name: piccolo-yaml
      mountPath: /etc/piccolo/yaml
    - name: config-path
      mountPath: /etc/piccolo/settings.yaml
  - name: settingsservice
    image: localhost/pullpiri:latest
    command: ["/piccolo/settingsservice", "--bind-address=$(HOST_IP)", "--bind-port=8080", "--log-level=debug"]
    volumeMounts:
    - name: piccolo-yaml
      mountPath: /etc/piccolo/yaml
    - name: config-path
      mountPath: /etc/piccolo/settings.yaml
    environment:
    - name: ROCKSDB_SERVICE_URL
      value: "http://$(HOST_IP):50051"
  volumes:
  - name: piccolo-yaml
    hostPath:
      path: /etc/piccolo/yaml
  - name: config-path
    hostPath:
      path: /etc/containers/systemd/piccolo/settings.yaml
  - name: rocksdb-data
    hostPath:
      path: /tmp/pullpiri_shared_rocksdb
